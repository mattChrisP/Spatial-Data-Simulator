<!DOCTYPE html>
<html>
<head>

    <!-- CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <!-- JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" 
            integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
            crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin="">
    </script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>

    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#uploadModal">
        Open Form
    </button>
    
    
    <button id="show-fav" type="button" class="btn btn-primary" data-toggle="modal" data-target="#permission-modal">
        Show Favourite Locations
    </button>
    <div class="modal fade" id="permission-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">We need your permission</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>To provide the best experience, we need access to your location.</p>
                </div>
                <div class="modal-footer">
                    <button id="grant-permission" type="button" class="btn btn-primary" data-dismiss="modal">
                        Allow Location Access
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="content">
        <div id="mapid"></div>
    </div>

    <div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">Upload Form</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form action="{{base_url}}/upload" method="post" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="img">Select image:</label>
                    <input type="file" class="form-control" id="img" name="img" accept="image/*">
                </div>
                <div class="form-group">
                    <label for="location_name">Location Name:</label>
                    <input type="text" class="form-control" id="location_name" name="location_name">
                </div>
                <div class="form-group">
                    <label for="tags">Tags:</label>
                    <input type="text" class="form-control" id="tags" name="tags">
                </div>
                <input type="hidden" id="longitude" name="longitude" value=""><br><br>
                <input type="hidden" id="latitude" name="latitude" value=""><br><br>

                <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>
            </div>
        </div>
    </div>
    


    <script>
        var base_url = "{{base_url}}";
        var userMarker;

        var curLat;
        var curLong;

        var btn = document.getElementById("grant-permission");
        var x = document.getElementById("demo");
        var showFavButton = document.getElementById("show-fav");


        function getLocations() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation is not supported by this browser.'));
                } else {
                    navigator.geolocation.getCurrentPosition(resolve, reject);
                }
            });
        }

        function showPosition(position) {
            x.innerHTML = "Latitude: " + position.coords.latitude + 
            "<br>Longitude: " + position.coords.longitude;
        }

        var mymap = L.map('mapid').setView([51.505, -0.09], 13);
    
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data Â© <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors',
            maxZoom: 19,
        }).addTo(mymap);

        var clusterMarker = L.markerClusterGroup({
            iconCreateFunction: function(cluster) {
                return L.divIcon({ html: '<b>' + cluster.getChildCount() + '</b>' });
            }
        });

        btn.onclick = function() {

            // Reset the cluster marker
            if (clusterMarker) {
                clusterMarker.clearLayers();
            }
            getLocations().then(position => {
                curLat = position.coords.latitude;
                curLong = position.coords.longitude;
                showCurrentPosition(position);
                retrieveNearest(10, curLong, curLat);
            }).catch(error => {
                console.error(error);
            });
        }


        function retrieveNearest(k=10,long,lat){
            fetch(base_url + `/api/nearest/${k}/${long}/${lat}`)
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                // Store the points to be highlighted
                console.log(data);
                for (var i = 0; i < data.length; i++){
                    showMarker(data[i][3], data[i][2],data[i][1], data[i][0]);
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
            });
        }

        function showMarker(lat, long, url, name) {
            // Define the custom icon
            var localImageUrl = `../static/img/${name}.jpg`;
            // var localImageUrl = url_for('static', filename='img/${name}.jpg');
            fetch(localImageUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.blob();
                })
                .then(blob => {
                    var localImageUrl = URL.createObjectURL(blob);
                    var myIcon = L.divIcon({
                        className: 'my-div-icon',
                        html: `<div class="icon-content" style="background-image: url('${localImageUrl}');" title="${name}"></div>`,
                        iconSize: [60, 60],  // Size of the icon
                        iconAnchor: [19, 19],  // Point of the icon which will correspond to marker's location
                    });
                    // Add code here to add icon to map
                    var marker = L.marker([lat, long], {icon: myIcon});
                    clusterMarker.addLayer(marker);
                    mymap.addLayer(clusterMarker);
                    mymap.fitBounds(clusterMarker.getBounds());
                    marker.on('click', function(e) {
                        mymap.setView(e.target.getLatLng(), 25);
                    });
                })
                .catch(error => {
                    console.log('Looks like there was a problem: \n', error);
                    var myIcon = L.divIcon({
                        className: 'my-div-icon',
                        html: `<div class="icon-content" style="background-image: url('${url}');" title="${name}"></div>`,
                        iconSize: [60, 60],  // Size of the icon
                        iconAnchor: [19, 19],  // Point of the icon which will correspond to marker's location
                    });
                    var marker = L.marker([lat, long], {icon: myIcon});
                    clusterMarker.addLayer(marker);
                    mymap.addLayer(clusterMarker);
                    mymap.fitBounds(clusterMarker.getBounds());
                    marker.on('click', function(e) {
                        mymap.setView(e.target.getLatLng(), 25);
                    });
                });

        }


        function showCurrentPosition(position) {
            if (userMarker) {
                mymap.removeLayer(userMarker);
            }
            curLat = position.coords.latitude;
            curLong = position.coords.longitude;
            userMarker = L.marker([position.coords.latitude, position.coords.longitude]).addTo(mymap);

            document.getElementById('longitude').value = position.coords.longitude;
            document.getElementById('latitude').value = position.coords.latitude;

            mymap.setView([position.coords.latitude, position.coords.longitude], 13);
            // alert("Latitude: " + position.coords.latitude + 
            // "\nLongitude: " + position.coords.longitude);
        }
    </script>
</body>
</html>